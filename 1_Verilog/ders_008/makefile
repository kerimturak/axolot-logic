# === Ayarlar ===
RTL_DIR=rtl
TB_DIR=tb
WORK_DIR=work
WAVEFORM=wave.vcd
SYNTH_JSON=synth.json

# === AraÃ§lar ===
VLIB=vlib
VLOG=vlog
VSIM=vsim
YOSYS=yosys
GTK=gtkwave

# === Dosyalar ===
RTL_FILES := $(wildcard $(RTL_DIR)/*.v)
TB_FILES  := $(wildcard $(TB_DIR)/*.v)
ALL_FILES := $(TB_FILES) $(RTL_FILES)

# === Hedefler ===
.PHONY: all sim synth show clean

all: sim

check-top:
ifndef RTL_TOP
	$(error âŒ RTL_TOP tanÄ±mlanmalÄ±. Ã–rn: make sim RTL_TOP=cpu)
endif

setup: check-top
	@echo "[ğŸ§±] 1. vlib work"
	$(VLIB) $(WORK_DIR)

compile: check-top setup
	@echo "[ğŸ“] 2. vlog"
	$(VLOG) -work $(WORK_DIR) $(ALL_FILES)

sim_batch: check-top compile
	@echo "[ğŸš€] 3. vsim -c"
	$(VSIM) -c -work $(WORK_DIR) tb_$(RTL_TOP) -do "run -all; quit"
	@echo "[âœ”] SimÃ¼lasyon tamamlandÄ±."

sim: check-top compile
	@echo "[ğŸš€] 3. vsim"
	$(VSIM) -work $(WORK_DIR) tb_$(RTL_TOP) -do "run -all; quit"
	@echo "[âœ”] SimÃ¼lasyon tamamlandÄ±."

synth: check-top
	@if [ -z "$(RTL_FILES)" ]; then \
	  echo "âš ï¸  RTL dosyasÄ± bulunamadÄ±, sentez atlanÄ±yor."; \
	else \
	  echo "[ğŸ› ï¸] RTL dosyalarÄ± bulundu, sentez baÅŸlatÄ±lÄ±yor..."; \
	  $(YOSYS) -p "read_verilog $(RTL_FILES); synth -top $(RTL_TOP); write_json $(SYNTH_JSON)"; \
	  echo "[âœ”] Sentez tamamlandÄ±. Ã‡Ä±ktÄ±: $(SYNTH_JSON)"; \
	fi

show: check-top
	@if [ -z "$(RTL_FILES)" ]; then \
	  echo "âš ï¸  RTL dosyasÄ± bulunamadÄ±, ÅŸematik gÃ¶sterim atlanÄ±yor."; \
	else \
	  echo "[ğŸ“ˆ] Åematik oluÅŸturuluyor..."; \
	  $(YOSYS) -p "read_verilog $(RTL_FILES); synth -top $(RTL_TOP); show -format dot -prefix show_$(RTL_TOP) $(RTL_TOP)"; \
	fi

showview: show
	@if [ -f show_$(RTL_TOP).dot ]; then \
	  xdot show_$(RTL_TOP).dot; \
	else \
	  echo "âš ï¸  .dot dosyasÄ± bulunamadÄ±. Ã–nce 'make show RTL_TOP=...' komutunu Ã§alÄ±ÅŸtÄ±rÄ±n."; \
	fi

clean:
	rm -rf $(WORK_DIR) transcript vsim.wlf $(SYNTH_JSON) show_*.dot
	@echo "[âœ”] Temizlik tamamlandÄ±."
